---
title: "Using the John Conner Package to Downscale SILO Data"
author: "The ToowoombaTrio"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
  ---
  
  # Downscale SILO Hourly Data and Visualise Quality of Predictions
  
```{r}
  
library(JohnConner)
BoM_SILO_data <- downscale()
plot_density(BoM_SILO_data)

```

## Check Error
```{r}
rmse(BoM_SILO_data[, 3], BoM_SILO_data[, 6])

mae(BoM_SILO_data[, 3], BoM_SILO_data[, 6])
```

## Generate Map of Heat Stress

```{r}
library(raster)
library(fields)
library(reshape)
library(readr)

hourlyT <- BoM_SILO_data[, 6]
head(hourlyT)
head(QLD_SILO_and_hourly_stations)

header_info <- QLD_SILO_and_hourly_stations[, 2]

temp_threshold <- 10

hours_of_high_temps <- c()

for (x in length(hourlyT)) {
  hours_of_high_temps <- c(hours_of_high_temps,
                           length(hourlyT[, x][hourlyT[, x] > temp_threshold]))
}
hours_of_high_temps

df <- data.frame(header_info, hours_of_high_temps, QLD_SILO_and_hourly_stations$LATITUDE,
                 QLD_SILO_and_hourly_stations$LONGITUDE)
head(df)

# create the surface to plot
spline <- Tps(data.frame(df$QLD_SILO_and_hourly_stations.LONGITUDE,
                         df$QLD_SILO_and_hourly_stations.LATITUDE),
              df$hours_of_high_temps)
grid <- predictSurface(spline, nx = 2000, ny = 2000)
predict(spline, cbind(151.9507, -27.5598))

png(filename = "QLDmap.png", height = 20, width = 17, units = "cm", res = 100)
# plot qld outline and the surface over the top of surface

yaxis <- c(-30, -10)
xaxis <- c(135, 155)
border2 <- read_csv("../data-raw/qld2.csv")
border <- read_csv("../data-raw/qld.csv")
plot(border$x, border$y, type = "n", axes = "False", xlim = xaxis,
     ylim = yaxis, xlab = "", ylab = "")
image.plot(grid, horizontal = TRUE, add = TRUE)
polygon(border2$x, border2$y, col = "white", border = "white")
polygon(border$x, border$y)

dev.off()

# send email abut specific locations
our_email <- "toowoombatrio@gmail.com"
attachmentName <- "QLDmap.png"
#subscribers details

susbscribers <- read_table("../data-raw/susbscribers.txt")

library(mailR)

for (value in susbscribers$run) {
  email <- as.character(susbscribers[value,1])
  location <- as.character(susbscribers[value,2])
  lat <- as.numeric(susbscribers[value,3])
  lon <- as.numeric(susbscribers[value,4])
  hours_of_heat_stress <- as.character(round(predict(spline, cbind(lat,lon)),0))
  body_text <- paste("Hello from the Toowoomba Trio Your crops at",
                     location, "recieved",
                     hours_of_heat_stress,
                     "hours of heat stress yesterday")
  
  sender <- our_email
  recipients <- email
  send.mail(from = sender,
            to = recipients,
            subject = "Hours of heat stress yesterday",
            body = body_text,
            attach.files = attachmentName,
            smtp = list(host.name = "smtp.gmail.com", port = 465, 
                        user.name = "toowoombatrio@gmail.com",
                        passwd = "qwertyytrewq", ssl = TRUE),
            authenticate = TRUE,
            send = TRUE)
  
}
file.remove("QLDmap.png")

```